#!/usr/bin/env bash

set -eo pipefail; [[ $DOKKU_TRACE ]] && set -x
APP="$2"; PORT="$3"

# source in app env to get DOKKU_WAIT and any other necessary vars
[[ -f "$DOKKU_ROOT/$APP/ENV" ]] && source $DOKKU_ROOT/$APP/ENV
FILENAME="$DOKKU_ROOT/$APP/CHECKS"
WAIT="${DOKKU_WAIT:-5}"
MAX_ATTEMPTS=5

# Check to see if the container is running
if [[ -f $DOKKU_ROOT/$APP/CONTAINER ]]; then
	oldid=$(< "$DOKKU_ROOT/$APP/CONTAINER")
	status=$(docker inspect $oldid || true)

	# Allow the app to be deployed if not running
	if ! [[ $status =~ '"Running": true' ]]; then
		echo "App not running. Deploying immediately..."
		exit 0
	else
		echo "App is running. Checking that new container is ready..."
	fi
else
	# Allow the app to be deployed for the first time
	echo "App not running. Deploying immediately..."
	exit 0
fi

echo "Waiting $WAIT seconds ..."
sleep $WAIT

# -q           do not use .curlrc (must come first)
# --compressed Test compression handled correctly
# --fail       Fail on server errors (4xx, 5xx)
# --location   Follow redirects
CURL_OPTIONS="-q --compressed --fail --location --max-time 30"
URL="http://localhost:$PORT/"

attempts=0
success=false

until [ $attempts -ge $MAX_ATTEMPTS ]
do
	echo "checking with: curl $CURL_OPTIONS $URL"
	if OUTPUT=$(curl -I $CURL_OPTIONS $URL 2>&1) ; then
		if [[ "$OUTPUT" =~ "HTTP/1.1 200 OK" ]] ; then
			success=true
			echo "HTTP/1.1 200 OK" && break
		fi
	fi
	attempts=$[$attempts+1]
	echo "FAILED ATTEMPT #$attempts"
	echo "Response:"
	echo $OUTPUT
	echo "Waiting $WAIT seconds ..."
	sleep $WAIT
done

if $success ; then
	echo -e "\033[32m\033[1mAll checks successful!\033[0m"
else
	echo "FAILED TO LOAD APP"
	exit 2
fi
